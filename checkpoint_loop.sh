#!/bin/bash

tmp=`mktemp`
. ~/bin/target-functions.sh
for f in `cat targets.checkpoint`
do
    echo $(gethost "$f")
done > "$tmp"
msfconsole -r - << EOF

use auxiliary/gather/checkpoint_hostname
<ruby>
# Create pass_input.txt as the list of passwords that should be looped through.
# Each will be read as next_pass.
# next_pass will be written to pass_file.txt, which should be the Metasploit pass_file value.
# The sleep command is in seconds, and won't run during the first run of the loop.

    begin

    File.foreach("$tmp", "\n") do |next_host|
        run_single("set rhost #{next_host}")
        run_single("spool 'SecuRemote Topology Service Hostname Disclosure on #{next_host}'")
        run_single("show options")
        run_single("run")           
        run_single("spool off")
        end

    end
</ruby>
exit
EOF
