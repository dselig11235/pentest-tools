#!/bin/bash

script=$(readlink -f "$0")
dir=$(dirname "$script")
. "$dir/target-functions.sh"
. "$dir/screenshot-functions.sh"

for t in `cat targets.ssh`
do
    temp=`mktemp`
    spool "$temp" nmap --script ssh2-enum-algos -p $(getport $t) $(gethost $t)
    temp2=`mktemp`
    "$dir/sshcolor.pl" "$temp.spl" | grep -v '^$' > "$temp2"
    rm "$temp.spl"
    kex='Key Exchange Algorithms Used on Multiple SSH Servers.spl'
    cat "$temp2" | between.pl '' 'server_host_key_algorithms:' \
        'Nmap done' 'Nmap done' >> "$kex"
    echo >> "$kex"
    serverkey='SSH Host Keys Used on Multiple Servers.spl'
    cat "$temp2" | between.pl '' 'kex_algorithms:' 'server_host_key_algorithms:' 'encryption_algorithms:' \
        'Nmap done' 'Nmap done' >> "$serverkey"
    echo >> "$serverkey"
    encryption='Insecure Encryption Algorithms Used on Multiple SSH Servers.spl'
    cat "$temp2" | between.pl '' 'kex_algorithms:' 'encryption_algorithms:' 'mac_algorithms:' \
        'Nmap done' 'Nmap done' >> "$encryption"
    echo >> "$encryption"
    macs='Message Authentication Code Algorithms Used on Multiple SSH Servers.spl'
    cat "$temp2" | between.pl '' 'kex_algorithms:' 'mac_algorithms:' 'compression_algorithms:' \
        'Nmap done' 'Nmap done' >> "$macs"
    echo >> "$macs"
done
