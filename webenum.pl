#!/usr/bin/perl

use Getopt::Std;
use Digest::SHA qw(sha512_base64);

sub url_encode {
    my $rv = shift;
    $rv =~ s/([^a-z\d\Q.-_~ \E])/sprintf("%%%2.2X", ord($1))/geix;
    $rv =~ tr/ /+/;
    return $rv;
}


sub url_decode {
    my $rv = shift;
    $rv =~ tr/+/ /;
    $rv =~ s/\%([a-f\d]{2})/ pack 'C', hex $1 /geix;
    return $rv;
}

sub encode {
    my $target = shift;
    $target =~ tr'/'%';
    return $target;
}

sub decode {
    my $file = shift;
    $file =~ tr'%'/';
    return $target;
}

sub printToFile {
    my ($filename, $msg) = @_;
    open(my $out, ">", "$filename")
        or die "Couldn't open file '$filename'";
    print $out $msg;
    close $out;
}

if(! -e 'targets.web') {
    if(! -e 'targets.http' and ! -e 'targets.https') {
        die "Cant't find targets.web, targets.http, or targets.https";
    }
    open(WebFile, '>', 'targets.web')
        or die "Can't open targets.web for writing";
    if(open(HTTPFile, '<', 'targets.http')) {
        while(<HTTPFile>) {
            if($_ =~ m'(.*):(\d+)/tcp') {
                print WebFile "http://$1:$2\n";
            }
        }
    }
    close HTTPFile;
    if(open(HTTPSFile, '<', 'targets.https')) {
        while(<HTTPSFile>) {
            if($_ =~ m'(.*):(\d+)/tcp') {
                print WebFile "https://$1:$2\n";
            }
        }
    }
    close HTTPSFile;
    close WebFile;
}

open(my $tfile, '<', 'targets.web')
    or die "Couldn't open file targets.web";

while(<$tfile>) {
    chomp;
    print "Processing $_\n";
    my $dir = "web." . encode($_);
    system("mkdir", "-p", $dir);
    my $info = `curl -kLs -o "$dir/index.html" -D "$dir/headers" -w "%{url_effective},%{http_code}" "$_"`;
    system("curl", "-kfLso", "$dir/robots.txt", "$_/robots.txt");
    #print qq(curl -kLs -o "$dir/index.html" -D "$dir/headers" -w "%{url_effective},%{http_code}" "$_"), "\n";
    @info = split(/,\s*/, $info);
    system('webshot.py', $_, "$dir/screenshot.png");
    printToFile("$dir/url_effective", $info[0]);
    printToFile("$dir/code", $info[1]);
    if(open(my $htmlfile, "<", "$dir/index.html")) {
        my $html = do {
            local $/ = undef;
            <$htmlfile>;
        };
        printToFile("$dir/sha", sha512_base64($html));
        if($html =~ m'<title>(.*)</title>'sm) {
            printToFile("$dir/title", $1);
        } else {
            printToFile("$dir/title", '');
        }
    }
    close $index;
    close $out;
}
